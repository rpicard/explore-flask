

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Storing data &mdash; Explore Flask 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Explore Flask 1.0 documentation" href="index.html"/>
        <link rel="next" title="Handling forms" href="forms.html"/>
        <link rel="prev" title="Static files" href="static.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Explore Flask</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preface.html#assumptions">Assumptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#living-document">Living document</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#conventions-used-in-this-book">Conventions used in this book</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#easter-eggs">Easter eggs</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">Coding conventions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#let-s-have-a-pep-rally">Let&#8217;s have a PEP rally!</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#relative-imports">Relative imports</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="environment.html#use-virtualenv-to-manage-your-environment">Use virtualenv to manage your environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#version-control">Version control</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#debugging">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="organizing.html">Organizing your project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#definitions">Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#organization-patterns">Organization patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#the-simple-case">The simple case</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#instance-folder">Instance folder</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuring-based-on-environment-variables">Configuring based on environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views.html">Advanced patterns for views and routing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views.html#view-decorators">View decorators</a></li>
<li class="toctree-l2"><a class="reference internal" href="views.html#url-converters">URL Converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="views.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="blueprints.html">Blueprints</a><ul>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#what-is-a-blueprint">What is a blueprint?</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#why-would-you-use-blueprints">Why would you use blueprints?</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#where-do-you-put-them">Where do you put them?</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#how-do-you-use-them">How do you use them?</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#refactoring-small-apps-to-use-blueprints">Refactoring small apps to use blueprints</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="templates.html#a-quick-primer-on-jinja">A quick primer on Jinja</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#how-to-organize-templates">How to organize templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#inheritance">Inheritance</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#creating-macros">Creating macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#custom-filters">Custom filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="static.html">Static files</a><ul>
<li class="toctree-l2"><a class="reference internal" href="static.html#organizing-your-static-files">Organizing your static files</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#manage-static-assets-with-flask-assets">Manage static assets with Flask-Assets</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Storing data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sqlalchemy">SQLAlchemy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="forms.html">Handling forms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="forms.html#flask-wtf">Flask-WTF</a></li>
<li class="toctree-l2"><a class="reference internal" href="forms.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="users.html">Patterns for handling users</a><ul>
<li class="toctree-l2"><a class="reference internal" href="users.html#email-confirmation">Email confirmation</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#storing-passwords">Storing passwords</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#authentication">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#forgot-your-password">Forgot your password</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#the-host">The Host</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#the-stack">The stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conclusion.html">Conclusion</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Explore Flask</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Storing data</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/storing.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="storing-data">
<h1>Storing data<a class="headerlink" href="#storing-data" title="Permalink to this headline">¶</a></h1>
<img alt="Storing data" src="_images/storing.png" />
<p>Most Flask applications are going to deal with storing data at some
point. There are many different ways to store data. Finding the best one
depends entirely on the data you are going to store. If you are storing
relational data (e.g. a user has posts, posts have a user, etc.) a
relational database is probably going to be the way to go (big suprise).
Other types of data might be more suited to NoSQL data stores, such as
MongoDB.</p>
<p>I&#8217;m not going to tell you how to choose a database engine for your
application. There are people who will tell you that NoSQL is the only
way to go and those who will say the same about relational databases.
All I will say on that subject is that if you are unsure, a relational
database (MySQL, PostgreSQL, etc.) will almost certainly work for
whatever you&#8217;re doing.</p>
<p>Plus, when you use a relational database you get to use SQLAlchemy and
SQLAlchemy is fun.</p>
<div class="section" id="sqlalchemy">
<h2>SQLAlchemy<a class="headerlink" href="#sqlalchemy" title="Permalink to this headline">¶</a></h2>
<p>SQLAlchemy is an ORM (Object Relational Mapper). It&#8217;s basically an
abstraction layer that sits on top of the raw SQL queries being executed
on our database. It provides a consistent API to a long list of database
engines. The most popular include MySQL, PostgreSQL and SQLite. This
makes it easy to move data between our models and our database and it
makes it really easy to do other things like switch database engines and
migrate our schemas.</p>
<p>There is a great Flask extension that makes using SQLAlchemy in Flask
even easier. It&#8217;s called Flask-SQLAlchemy. Flask-SQLAlchemy configures a
lot of sane defaults for SQLAlchemy. It also handles some session
management so we don&#8217;t have to deal with janitorial stuff in our
application code.</p>
<p>Let&#8217;s dive into some code. We&#8217;re going to define some models then
configure some SQLAlchemy. The models are going to go in
<em>myapp/models.py</em>, but first we are going to define our database in
<em>myapp/**init*</em>.py*</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># ourapp/__init__.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="n">instance_relative_config</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s">&#39;config.py&#39;</span><span class="p">)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>First we initialize and configure our Flask app and then we use it to
initialize our SQLAlchemy database handler. We&#8217;re going to use an
instance folder for our database configuration so we should use the
<tt class="docutils literal"><span class="pre">instance_relative_config</span></tt> option when initializing the app and then
call <tt class="docutils literal"><span class="pre">app.config.from_pyfile</span></tt> to load it. Then we can define our
models.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># ourapp/models.py</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="c"># Columns</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>

    <span class="n">thrust</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">Column</span></tt>, <tt class="docutils literal"><span class="pre">Integer</span></tt>, <tt class="docutils literal"><span class="pre">String</span></tt>, <tt class="docutils literal"><span class="pre">Model</span></tt> and other SQLAlchemy
classes are all available via the <tt class="docutils literal"><span class="pre">db</span></tt> object constructed from
Flask-SQLAlchemy. We have defined a model to store the
current state of our spacecraft&#8217;s engines. Each engine has an id, a
title and a thrust level.</p>
<p>We still need to add some database information to our configuration.
We&#8217;re using an instance folder to keep confidential configuration
variables out of version control, so we are going to put it in
<em>instance/config.py</em>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># instance/config.py</span>

<span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">&quot;postgresql://user:password@localhost/spaceshipDB&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Your database URI will be different depending on the engine you use and where it&#8217;s hosted. See the <a class="reference external" href="http://docs.sqlalchemy.org/en/latest/core/engines.html?highlight=database#database-urls">SQLAlchemy documentation for this syntax</a>.</p>
</div>
<div class="section" id="initializing-the-database">
<h3>Initializing the database<a class="headerlink" href="#initializing-the-database" title="Permalink to this headline">¶</a></h3>
<p>Now that the database is configured and we have defined a model, we can
initialize the database. This step basically involves creating the
database schema from the model definitions.</p>
<p>Normally that process might be a pain in the ... neck. Lucky for us,
SQLAlchemy has a really cool command that will do all of this for us.</p>
<p>Let&#8217;s open up a Python terminal in our repository root.</p>
<div class="highlight-python"><div class="highlight"><pre>$ pwd
/Users/me/Code/myapp
$ workon myapp
(myapp)$ python
Python 2.7.5 (default, Aug 25 2013, 00:04:04)
[GCC 4.2.1 Compatible Apple LLVM 5.0 (clang-500.0.68)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from myapp import db
&gt;&gt;&gt; db.create_all()
&gt;&gt;&gt;
</pre></div>
</div>
<p>Now, thanks to SQLAlchemy, our tables have been created in the database
specified in our configuration.</p>
</div>
<div class="section" id="alembic-migrations">
<h3>Alembic migrations<a class="headerlink" href="#alembic-migrations" title="Permalink to this headline">¶</a></h3>
<p>The schema of a database is not set in stone. For example, we may want
to add a <tt class="docutils literal"><span class="pre">last_fired</span></tt> column to the engine table. If we don&#8217;t have any
data, we can just update the model and run <tt class="docutils literal"><span class="pre">db.create_all()</span></tt> again.
However, if we have six months of engine data logged in that table, we
probably don&#8217;t want to start over from scratch. That&#8217;s where database
migrations come in.</p>
<p>Alembic is a database migration tool created specifically for use with
SQL-Alchemy. It lets us keep a versioned history of our database schema
so that we can later upgrade to a new schema and even downgrade back to
an older one.</p>
<p>Alembic has an extensive tutorial to get you started, so I&#8217;ll just give
you a quick overview and point out a couple of things to watch out for.</p>
<p>We&#8217;ll create our alembic &#8220;migration environment&#8221; via the
<tt class="docutils literal"><span class="pre">alembic</span> <span class="pre">init</span></tt> command. Once we run this in our repository root
we&#8217;ll have a new directory with the very creative name <em>alembic</em>. Our
repository will end up looking something like the example in this listing,
adapted from the Alembic tutorial.</p>
<div class="highlight-python"><div class="highlight"><pre>ourapp/
    alembic.ini
    alembic/
        env.py
        README
        script.py.mako
        versions/
            3512b954651e_add_account.py
            2b1ae634e5cd_add_order_id.py
            3adcc9a56557_rename_username_field.py
    myapp/
        __init__.py
        views.py
        models.py
        templates/
    run.py
    config.py
    requirements.txt
</pre></div>
</div>
<p>The <em>alembic/</em> directory has the scripts that migrate our data between
versions. There is also an <em>alembic.ini</em> file that contains
configuration information.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Add <em>alembic.ini</em> to <em>.gitignore</em>! You are going to have your database
credentials in this file, so you <strong>do not</strong> want it to end up in version
control.</p>
<p class="last">You do want to keep <em>alembic/</em> in version control though. It does not
contain sensitive information (that can&#8217;t already be derived from your
source code) and keeping it in version control will mean having multiple
copies should something happen to the files on your computer.</p>
</div>
<p>When it comes time to make a schema change, there are a couple of steps.
First we run <tt class="docutils literal"><span class="pre">alembic</span> <span class="pre">revision</span></tt> to generate a migration script. Then
we&#8217;ll open up the newly generated Python file in
<em>myapp/alembic/versions/</em> and fill in the <tt class="docutils literal"><span class="pre">upgrade</span></tt> and <tt class="docutils literal"><span class="pre">downgrade</span></tt>
functions using the tools provided by Alembic&#8217;s <tt class="docutils literal"><span class="pre">op</span></tt> object.</p>
<p>Once we have our migration script ready, we can run
<tt class="docutils literal"><span class="pre">alembic</span> <span class="pre">upgrade</span> <span class="pre">head</span></tt> to migrade our data to the latest version.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For the details on configuring Alembic, creating your migration scripts and running your migrations, see <a class="reference external" href="http://alembic.readthedocs.org/en/latest/tutorial.html">the Alembic tutorial</a>.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Don&#8217;t forget to put a plan in place to back up your data. The details of that plan are outside the scope of this book, but you should always have your database backed up in a secure and robust way.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The NoSQL scene is less established with Flask, but as long as the database engine of your choice has a Python library, you should be able to use it. There are even several extensions in <a class="reference external" href="http://flask.pocoo.org/extensions/">the Flask extension registry</a> to help integrate NoSQL engines with Flask.</p>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Use SQLAlchemy to work with relational databases.</li>
<li>Use Flask-SQLAlchemy to work with SQLAlchemy.</li>
<li>Alembic helps you migrate your data between schema changes.</li>
<li>You can use NoSQL databases with Flask, but the methods and tools
vary between engines.</li>
<li>Back up your data!</li>
</ul>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="forms.html" class="btn btn-neutral float-right" title="Handling forms"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="static.html" class="btn btn-neutral" title="Static files"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Robert Picard.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50579609-1', 'exploreflask.com');
  ga('send', 'pageview');

</script>


</body>
</html>